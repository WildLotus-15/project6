{% load static %}
<!DOCTYPE html>
<html>

<head>
	<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700,300' rel='stylesheet'
		type='text/css'>
	<script src="https://use.typekit.net/hoy3lrg.js"></script>
	<script>try { Typekit.load({ async: true }); } catch (e) { }</script>
	<link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css'>
	<link rel='stylesheet prefetch'
		href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css'>
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
	<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="https://unpkg.com/@trevoreyre/autocomplete-js"></script>
	<link rel="stylesheet" href="{% static 'chat/css/styles.css' %}" />
</head>

<body>
	<div id="frame">
		<div id="sidepanel">
			<div id="profile">
				<div class="wrap">
					<a href="{% url 'profile' request.user.id %}">
						<img id="profile-img" src="{{ request.user.profile.picture.url }}" alt="" />
						<p>{{ request.user.username }}</p>
					</a>
				</div>
			</div>
			<div>
				{% for group in groups %}
				<a href="{% url 'chat:room' group.name %}" id="aleko">
					{{ group.name }}
				</a>
				{% endfor %}
			</div>
			<div id="contacts">
				<ul>
				</ul>
			</div>
			<div id="bottom-bar">
				<a href=""></a>
				<button id="addcontact" class="w-100">
					<a href="{% url 'chat:rooms' %}">Join a Chat Room</a>
				</button>
			</div>
		</div>
		<div class="content">
			<div class="contact-profile">
				<img src="{{ group.picture.url }}" alt="">
				<p>{{ group.name }}</p>
			</div>

			{% if request.user in group.users.all %}

			<div class="messages">
				<ul id="chat-log">

				</ul>
			</div>

			<div class="message-input">
				<div class="wrap">
					<input id="chat-message-input" type="text" placeholder="Write your message..." />
					<button id="chat-message-submit" class="submit">
						<i class="fa fa-paper-plane" aria-hidden="true"></i>
					</button>
				</div>
			</div>

			{% else %}

			<div class="d-flex align-items-center justify-content-center flex-column" style="min-height: 640px;">
				<div class="p-2 text-muted">
					<h5 class="text-muted">First you have to join specified chat room, in order to see and type messages.</h5>
				</div>
			</div>

			{% endif %}
		</div>
	</div>

	<script src="{% static 'chat/js/main.js' %}"></script>
	<script src="{% static 'chat/js/reconnecting-websocket.js' %}"></script>
	<script>
		var roomName = {{ room_name_json }};
		var username = {{ username }};

		var chatSocket = new ReconnectingWebSocket(
			'ws://' + window.location.host +
			'/ws/chat/room' + roomName + '/');

		chatSocket.onopen = function (e) {
			fetchMessages();
		}

		chatSocket.onmessage = function (e) {
			var data = JSON.parse(e.data);
			if (data['command'] === 'messages') {
				for (let i = 0; i < data['messages'].length; i++) {
					createMessage(data['messages'][i]);
				}
			} else if (data['command'] === 'new_message') {
				createMessage(data['message']);
			}
		};

		chatSocket.onclose = function (e) {
			console.error('Chat socket closed unexpectedly');
		};

		document.querySelector('#chat-message-input').onkeyup = function (e) {
			if (e.keyCode === 13) {  // enter, return
				document.querySelector('#chat-message-submit').click();
			}
		};

		document.querySelector('#chat-message-submit').onclick = function (e) {
			var messageInputDom = document.getElementById('chat-message-input');
			var message = messageInputDom.value;
			chatSocket.send(JSON.stringify({
				'command': 'new_message',
				'message': message,
				'from': username,
				'group_name': roomName
			}));

			messageInputDom.value = '';
		};

		function fetchMessages() {
			chatSocket.send(JSON.stringify({ 'command': 'fetch_messages', "group_name": roomName }));
		}

		function createMessage(data) {
			var author = document.createElement('a')
			author.href = `/profile/${data.author_id}`
			author.innerHTML = data['author'];

			var author_picture = data["author_picture"];

			var msgListTag = document.createElement('li');

			var wrapperTag = document.createElement('div');

			var imgTag = document.createElement('img');
			imgTag.src = author_picture
			imgTag.addEventListener('click', () => {
				window.location.href = `/profile/${data.author_id}`
			})

			var messageTag = document.createElement('div')
			messageTag.textContent = data.content;

			var timestampTag = document.createElement('div');
			timestampTag.textContent = data["timestamp"]

			wrapperTag.appendChild(author)
			wrapperTag.appendChild(messageTag)
			wrapperTag.appendChild(timestampTag)

			msgListTag.className = 'sent';

			msgListTag.appendChild(imgTag);

			msgListTag.append(wrapperTag);

			document.querySelector('#chat-log').appendChild(msgListTag);
		}

	</script>
</body>

</html>